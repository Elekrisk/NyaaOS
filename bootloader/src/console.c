#include "console.h"

#include <stdint.h>

#include "printf.h"
#include "builtins.h"

struct Font
{
    int char_width;
    int char_height;
    size_t glyph_count;
    uint8_t **glyphs;
};

struct ConsoleConfig
{
    uint32_t *address;
    uint64_t width;
    uint64_t height;
    uint64_t pitch;
    uint32_t scale;
    struct Font font;
} config;

#define ________________ 0b00000000,
#define ______________XX 0b00000001,
#define ____________XX__ 0b00000010,
#define ____________XXXX 0b00000011,
#define __________XX____ 0b00000100,
#define __________XX__XX 0b00000101,
#define __________XXXX__ 0b00000110,
#define __________XXXXXX 0b00000111,
#define ________XX______ 0b00001000,
#define ________XX____XX 0b00001001,
#define ________XX__XX__ 0b00001010,
#define ________XX__XXXX 0b00001011,
#define ________XXXX____ 0b00001100,
#define ________XXXX__XX 0b00001101,
#define ________XXXXXX__ 0b00001110,
#define ________XXXXXXXX 0b00001111,
#define ______XX________ 0b00010000,
#define ______XX______XX 0b00010001,
#define ______XX____XX__ 0b00010010,
#define ______XX____XXXX 0b00010011,
#define ______XX__XX____ 0b00010100,
#define ______XX__XX__XX 0b00010101,
#define ______XX__XXXX__ 0b00010110,
#define ______XX__XXXXXX 0b00010111,
#define ______XXXX______ 0b00011000,
#define ______XXXX____XX 0b00011001,
#define ______XXXX__XX__ 0b00011010,
#define ______XXXX__XXXX 0b00011011,
#define ______XXXXXX____ 0b00011100,
#define ______XXXXXX__XX 0b00011101,
#define ______XXXXXXXX__ 0b00011110,
#define ______XXXXXXXXXX 0b00011111,
#define ____XX__________ 0b00100000,
#define ____XX________XX 0b00100001,
#define ____XX______XX__ 0b00100010,
#define ____XX______XXXX 0b00100011,
#define ____XX____XX____ 0b00100100,
#define ____XX____XX__XX 0b00100101,
#define ____XX____XXXX__ 0b00100110,
#define ____XX____XXXXXX 0b00100111,
#define ____XX__XX______ 0b00101000,
#define ____XX__XX____XX 0b00101001,
#define ____XX__XX__XX__ 0b00101010,
#define ____XX__XX__XXXX 0b00101011,
#define ____XX__XXXX____ 0b00101100,
#define ____XX__XXXX__XX 0b00101101,
#define ____XX__XXXXXX__ 0b00101110,
#define ____XX__XXXXXXXX 0b00101111,
#define ____XXXX________ 0b00110000,
#define ____XXXX______XX 0b00110001,
#define ____XXXX____XX__ 0b00110010,
#define ____XXXX____XXXX 0b00110011,
#define ____XXXX__XX____ 0b00110100,
#define ____XXXX__XX__XX 0b00110101,
#define ____XXXX__XXXX__ 0b00110110,
#define ____XXXX__XXXXXX 0b00110111,
#define ____XXXXXX______ 0b00111000,
#define ____XXXXXX____XX 0b00111001,
#define ____XXXXXX__XX__ 0b00111010,
#define ____XXXXXX__XXXX 0b00111011,
#define ____XXXXXXXX____ 0b00111100,
#define ____XXXXXXXX__XX 0b00111101,
#define ____XXXXXXXXXX__ 0b00111110,
#define ____XXXXXXXXXXXX 0b00111111,
#define __XX____________ 0b01000000,
#define __XX__________XX 0b01000001,
#define __XX________XX__ 0b01000010,
#define __XX________XXXX 0b01000011,
#define __XX______XX____ 0b01000100,
#define __XX______XX__XX 0b01000101,
#define __XX______XXXX__ 0b01000110,
#define __XX______XXXXXX 0b01000111,
#define __XX____XX______ 0b01001000,
#define __XX____XX____XX 0b01001001,
#define __XX____XX__XX__ 0b01001010,
#define __XX____XX__XXXX 0b01001011,
#define __XX____XXXX____ 0b01001100,
#define __XX____XXXX__XX 0b01001101,
#define __XX____XXXXXX__ 0b01001110,
#define __XX____XXXXXXXX 0b01001111,
#define __XX__XX________ 0b01010000,
#define __XX__XX______XX 0b01010001,
#define __XX__XX____XX__ 0b01010010,
#define __XX__XX____XXXX 0b01010011,
#define __XX__XX__XX____ 0b01010100,
#define __XX__XX__XX__XX 0b01010101,
#define __XX__XX__XXXX__ 0b01010110,
#define __XX__XX__XXXXXX 0b01010111,
#define __XX__XXXX______ 0b01011000,
#define __XX__XXXX____XX 0b01011001,
#define __XX__XXXX__XX__ 0b01011010,
#define __XX__XXXX__XXXX 0b01011011,
#define __XX__XXXXXX____ 0b01011100,
#define __XX__XXXXXX__XX 0b01011101,
#define __XX__XXXXXXXX__ 0b01011110,
#define __XX__XXXXXXXXXX 0b01011111,
#define __XXXX__________ 0b01100000,
#define __XXXX________XX 0b01100001,
#define __XXXX______XX__ 0b01100010,
#define __XXXX______XXXX 0b01100011,
#define __XXXX____XX____ 0b01100100,
#define __XXXX____XX__XX 0b01100101,
#define __XXXX____XXXX__ 0b01100110,
#define __XXXX____XXXXXX 0b01100111,
#define __XXXX__XX______ 0b01101000,
#define __XXXX__XX____XX 0b01101001,
#define __XXXX__XX__XX__ 0b01101010,
#define __XXXX__XX__XXXX 0b01101011,
#define __XXXX__XXXX____ 0b01101100,
#define __XXXX__XXXX__XX 0b01101101,
#define __XXXX__XXXXXX__ 0b01101110,
#define __XXXX__XXXXXXXX 0b01101111,
#define __XXXXXX________ 0b01110000,
#define __XXXXXX______XX 0b01110001,
#define __XXXXXX____XX__ 0b01110010,
#define __XXXXXX____XXXX 0b01110011,
#define __XXXXXX__XX____ 0b01110100,
#define __XXXXXX__XX__XX 0b01110101,
#define __XXXXXX__XXXX__ 0b01110110,
#define __XXXXXX__XXXXXX 0b01110111,
#define __XXXXXXXX______ 0b01111000,
#define __XXXXXXXX____XX 0b01111001,
#define __XXXXXXXX__XX__ 0b01111010,
#define __XXXXXXXX__XXXX 0b01111011,
#define __XXXXXXXXXX____ 0b01111100,
#define __XXXXXXXXXX__XX 0b01111101,
#define __XXXXXXXXXXXX__ 0b01111110,
#define __XXXXXXXXXXXXXX 0b01111111,
#define XX______________ 0b10000000,
#define XX____________XX 0b10000001,
#define XX__________XX__ 0b10000010,
#define XX__________XXXX 0b10000011,
#define XX________XX____ 0b10000100,
#define XX________XX__XX 0b10000101,
#define XX________XXXX__ 0b10000110,
#define XX________XXXXXX 0b10000111,
#define XX______XX______ 0b10001000,
#define XX______XX____XX 0b10001001,
#define XX______XX__XX__ 0b10001010,
#define XX______XX__XXXX 0b10001011,
#define XX______XXXX____ 0b10001100,
#define XX______XXXX__XX 0b10001101,
#define XX______XXXXXX__ 0b10001110,
#define XX______XXXXXXXX 0b10001111,
#define XX____XX________ 0b10010000,
#define XX____XX______XX 0b10010001,
#define XX____XX____XX__ 0b10010010,
#define XX____XX____XXXX 0b10010011,
#define XX____XX__XX____ 0b10010100,
#define XX____XX__XX__XX 0b10010101,
#define XX____XX__XXXX__ 0b10010110,
#define XX____XX__XXXXXX 0b10010111,
#define XX____XXXX______ 0b10011000,
#define XX____XXXX____XX 0b10011001,
#define XX____XXXX__XX__ 0b10011010,
#define XX____XXXX__XXXX 0b10011011,
#define XX____XXXXXX____ 0b10011100,
#define XX____XXXXXX__XX 0b10011101,
#define XX____XXXXXXXX__ 0b10011110,
#define XX____XXXXXXXXXX 0b10011111,
#define XX__XX__________ 0b10100000,
#define XX__XX________XX 0b10100001,
#define XX__XX______XX__ 0b10100010,
#define XX__XX______XXXX 0b10100011,
#define XX__XX____XX____ 0b10100100,
#define XX__XX____XX__XX 0b10100101,
#define XX__XX____XXXX__ 0b10100110,
#define XX__XX____XXXXXX 0b10100111,
#define XX__XX__XX______ 0b10101000,
#define XX__XX__XX____XX 0b10101001,
#define XX__XX__XX__XX__ 0b10101010,
#define XX__XX__XX__XXXX 0b10101011,
#define XX__XX__XXXX____ 0b10101100,
#define XX__XX__XXXX__XX 0b10101101,
#define XX__XX__XXXXXX__ 0b10101110,
#define XX__XX__XXXXXXXX 0b10101111,
#define XX__XXXX________ 0b10110000,
#define XX__XXXX______XX 0b10110001,
#define XX__XXXX____XX__ 0b10110010,
#define XX__XXXX____XXXX 0b10110011,
#define XX__XXXX__XX____ 0b10110100,
#define XX__XXXX__XX__XX 0b10110101,
#define XX__XXXX__XXXX__ 0b10110110,
#define XX__XXXX__XXXXXX 0b10110111,
#define XX__XXXXXX______ 0b10111000,
#define XX__XXXXXX____XX 0b10111001,
#define XX__XXXXXX__XX__ 0b10111010,
#define XX__XXXXXX__XXXX 0b10111011,
#define XX__XXXXXXXX____ 0b10111100,
#define XX__XXXXXXXX__XX 0b10111101,
#define XX__XXXXXXXXXX__ 0b10111110,
#define XX__XXXXXXXXXXXX 0b10111111,
#define XXXX____________ 0b11000000,
#define XXXX__________XX 0b11000001,
#define XXXX________XX__ 0b11000010,
#define XXXX________XXXX 0b11000011,
#define XXXX______XX____ 0b11000100,
#define XXXX______XX__XX 0b11000101,
#define XXXX______XXXX__ 0b11000110,
#define XXXX______XXXXXX 0b11000111,
#define XXXX____XX______ 0b11001000,
#define XXXX____XX____XX 0b11001001,
#define XXXX____XX__XX__ 0b11001010,
#define XXXX____XX__XXXX 0b11001011,
#define XXXX____XXXX____ 0b11001100,
#define XXXX____XXXX__XX 0b11001101,
#define XXXX____XXXXXX__ 0b11001110,
#define XXXX____XXXXXXXX 0b11001111,
#define XXXX__XX________ 0b11010000,
#define XXXX__XX______XX 0b11010001,
#define XXXX__XX____XX__ 0b11010010,
#define XXXX__XX____XXXX 0b11010011,
#define XXXX__XX__XX____ 0b11010100,
#define XXXX__XX__XX__XX 0b11010101,
#define XXXX__XX__XXXX__ 0b11010110,
#define XXXX__XX__XXXXXX 0b11010111,
#define XXXX__XXXX______ 0b11011000,
#define XXXX__XXXX____XX 0b11011001,
#define XXXX__XXXX__XX__ 0b11011010,
#define XXXX__XXXX__XXXX 0b11011011,
#define XXXX__XXXXXX____ 0b11011100,
#define XXXX__XXXXXX__XX 0b11011101,
#define XXXX__XXXXXXXX__ 0b11011110,
#define XXXX__XXXXXXXXXX 0b11011111,
#define XXXXXX__________ 0b11100000,
#define XXXXXX________XX 0b11100001,
#define XXXXXX______XX__ 0b11100010,
#define XXXXXX______XXXX 0b11100011,
#define XXXXXX____XX____ 0b11100100,
#define XXXXXX____XX__XX 0b11100101,
#define XXXXXX____XXXX__ 0b11100110,
#define XXXXXX____XXXXXX 0b11100111,
#define XXXXXX__XX______ 0b11101000,
#define XXXXXX__XX____XX 0b11101001,
#define XXXXXX__XX__XX__ 0b11101010,
#define XXXXXX__XX__XXXX 0b11101011,
#define XXXXXX__XXXX____ 0b11101100,
#define XXXXXX__XXXX__XX 0b11101101,
#define XXXXXX__XXXXXX__ 0b11101110,
#define XXXXXX__XXXXXXXX 0b11101111,
#define XXXXXXXX________ 0b11110000,
#define XXXXXXXX______XX 0b11110001,
#define XXXXXXXX____XX__ 0b11110010,
#define XXXXXXXX____XXXX 0b11110011,
#define XXXXXXXX__XX____ 0b11110100,
#define XXXXXXXX__XX__XX 0b11110101,
#define XXXXXXXX__XXXX__ 0b11110110,
#define XXXXXXXX__XXXXXX 0b11110111,
#define XXXXXXXXXX______ 0b11111000,
#define XXXXXXXXXX____XX 0b11111001,
#define XXXXXXXXXX__XX__ 0b11111010,
#define XXXXXXXXXX__XXXX 0b11111011,
#define XXXXXXXXXXXX____ 0b11111100,
#define XXXXXXXXXXXX__XX 0b11111101,
#define XXXXXXXXXXXXXX__ 0b11111110,
#define XXXXXXXXXXXXXXXX 0b11111111,

// clang-format off
uint8_t glyphs[128][8] = {
    { // [0] NUL
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [1] SOH
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [2] STX
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [3] ETX
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [4] EOT
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [5] ENQ
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [6] ACK
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [7] BEL
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [8] BS
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [9] TAB
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [A] LF
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [B] VT
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [C] FF
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [D] CR
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [E] SO
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [F] SI
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [10] DLE
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [11] DC1
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [12] DC2
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [13] DC3
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [14] DC4
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [15] NAK
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [16] SYN
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [17] ETB
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [18] CAN
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [19] EM
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [1A] SUB
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [1B] ESC
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [1C] FS
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [1D] GS
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [1E] RS
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [1F] US
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [20]  
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [21] !
        ________________
        ______XX________
        ______XX________
        ______XX________
        ______XX________
        ________________
        ______XX________
        ________________
    },
    { // [22] "
        ________________
        ____XX__XX______
        ____XX__XX______
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [23] #
        ________________
        ____XX____XX____
        __XXXXXXXXXXXX__
        ____XX____XX____
        ____XX____XXXX__
        __XXXXXXXXXXXX__
        ____XX____XX____
        ________________
    },
    { // [24] $
        ______XX________
        ____XXXXXXXXXX__
        __XX__XX________
        ____XXXXXXXX____
        ______XX____XX__
        __XX__XX____XX__
        ____XXXXXXXX____
        ______XX________
    },
    { // [25] %
        ________________
        __XXXX______XX__
        __XXXX____XX____
        ________XX______
        ______XX________
        ____XX____XXXX__
        __XX______XXXX__
        ________________
    },
    { // [26] &
        ________________
        ____XXXXXX______
        __XX____________
        ____XXXXXXXX____
        __XX____XX______
        __XX______XX____
        ____XXXXXX______
        ________________
    },
    { // [27] '
        ________________
        ______XX________
        ______XX________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [28] (
        __________XX____
        ________XX______
        ______XX________
        ______XX________
        ______XX________
        ______XX________
        ________XX______
        __________XX____
    },
    { // [29] )
        ____XX__________
        ______XX________
        ________XX______
        ________XX______
        ________XX______
        ________XX______
        ______XX________
        ____XX__________
    },
    { // [2A] *
        ________________
        ____XX____XX____
        ______XXXX______
        ____XXXXXXXX____
        ______XXXX______
        ____XX____XX____
        ________________
        ________________
    },
    { // [2B] +
        ________________
        ______XX________
        ______XX________
        __XXXXXXXXXX____
        ______XX________
        ______XX________
        ________________
        ________________
    },
    { // [2C] ,
        ________________
        ________________
        ________________
        ________________
        ________________
        ______XX________
        ______XX________
        ____XX__________
    },
    { // [2D] -
        ________________
        ________________
        ________________
        __XXXXXXXXXX____
        ________________
        ________________
        ________________
        ________________
    },
    { // [2E] .
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ____XX__________
        ________________
    },
    { // [2F] /
        ________________
        ____________XX__
        __________XX____
        ________XX______
        ______XX________
        ____XX__________
        __XX____________
        ________________
    },
    { // [30] 0
        ________________
        ____XXXXXXXX____
        __XX________XX__
        __XX__XXXX__XX__
        __XX__XXXX__XX__
        __XX________XX__
        ____XXXXXXXX____
        ________________
    },
    { // [31] 1
        ________________
        ________XX______
        ______XXXX______
        ________XX______
        ________XX______
        ________XX______
        ____XXXXXXXX____
        ________________
    },
    { // [32] 2
        ________________
        ____XXXXXXXX____
        __XX________XX__
        ____________XX__
        ________XXXX____
        ____XXXX________
        __XXXXXXXXXXXX__
        ________________
    },
    { // [33] 3
        ________________
        ____XXXXXXXX____
        __XX________XX__
        ________XXXX____
        ____________XX__
        __XX________XX__
        ____XXXXXXXX____
        ________________
    },
    { // [34] 4
        ________________
        __XX________XX__
        __XX________XX__
        __XXXXXXXXXXXX__
        ____________XX__
        ____________XX__
        ____________XX__
        ________________
    },
    { // [35] 5
        ________________
        __XXXXXXXXXXXX__
        __XX____________
        __XXXXXXXXXX____
        ____________XX__
        __XX________XX__
        ____XXXXXXXX____
        ________________
    },
    { // [36] 6
        ________________
        ____XXXXXXXX____
        __XX____________
        __XXXXXXXXXX____
        __XX________XX__
        __XX________XX__
        ____XXXXXXXX____
        ________________
    },
    { // [37] 7
        ________________
        __XXXXXXXXXXXX__
        ____________XX__
        __________XX____
        ________XX______
        ______XX________
        ____XX__________
        ________________
    },
    { // [38] 8
        ________________
        ____XXXXXXXX____
        __XX________XX__
        ____XXXXXXXX____
        __XX________XX__
        __XX________XX__
        ____XXXXXXXX____
        ________________
    },
    { // [39] 9
        ________________
        ____XXXXXXXX____
        __XX________XX__
        __XX________XX__
        ____XXXXXXXXXX__
        ____________XX__
        ____XXXXXXXX____
        ________________
    },
    { // [3A] :
        ________________
        ________________
        ______XX________
        ________________
        ________________
        ________________
        ______XX________
        ________________
    },
    { // [3B] ;
        ________________
        ________________
        ______XX________
        ________________
        ________________
        ______XX________
        ______XX________
        ____XX__________
    },
    { // [3C] <
        ________________
        ________XX______
        ______XX________
        ____XX__________
        ______XX________
        ________XX______
        ________________
        ________________
    },
    { // [3D] =
        ________________
        ________________
        ________________
        __XXXXXXXXXXXX__
        ________________
        __XXXXXXXXXXXX__
        ________________
        ________________
    },
    { // [3E] >
        ________________
        ______XX________
        ________XX______
        __________XX____
        ________XX______
        ______XX________
        ________________
        ________________
    },
    { // [3F] ?
        ________________
        ______XXXX______
        ____XX____XX____
        ________XX______
        ________XX______
        ________________
        ________XX______
        ________________
    },
    {  // [40] @
        ________________
        __XXXXXXXXXXXX__
        __XX________XX__
        __XX__XXXX__XX__
        __XX__XXXX__XX__
        __XX__XXXX__XX__
        __XX__XXXXXXXX__
        ________________
    },
    { // [41] A
        ________________
        __XXXXXXXXXXXX__
        __XX________XX__
        __XXXXXXXXXXXX__
        __XX________XX__
        __XX________XX__
        __XX________XX__
        ________________
    },
    { // [42] B
        ________________
        __XXXXXXXXXXXX__
        __XX________XX__
        __XXXXXXXXXX____
        __XX________XX__
        __XX________XX__
        __XXXXXXXXXXXX__
        ________________
    },
    { // [43] C
        ________________
        ____XXXXXXXXXX__
        __XX____________
        __XX____________
        __XX____________
        __XX____________
        ____XXXXXXXXXX__
        ________________
    },
    { // [44] D
        ________________
        __XXXXXXXXXX____
        __XX________XX__
        __XX________XX__
        __XX________XX__
        __XX________XX__
        __XXXXXXXXXX____
        ________________
    },
    { // [45] E
        ________________
        __XXXXXXXXXXXX__
        __XX____________
        __XXXXXXXX______
        __XX____________
        __XX____________
        __XXXXXXXXXXXX__
        ________________
    },
    { // [46] F
        ________________
        __XXXXXXXXXXXX__
        __XX____________
        __XXXXXXXX______
        __XX____________
        __XX____________
        __XX____________
        ________________
    },
    { // [47] G
        ________________
        ____XXXXXXXX____
        __XX________XX__
        __XX____________
        __XX____XXXXXX__
        __XX________XX__
        ____XXXXXXXX____
        ________________
    },
    { // [48] H
        ________________
        __XX________XX__
        __XX________XX__
        __XXXXXXXXXXXX__
        __XX________XX__
        __XX________XX__
        __XX________XX__
        ________________
    },
    { // [49] I
        ________________
        ____XXXXXX______
        ______XX________
        ______XX________
        ______XX________
        ______XX________
        ____XXXXXX______
        ________________
    },
    { // [4A] J
        ________________
        __XXXXXXXXXXXX__
        ____________XX__
        ____________XX__
        __XX________XX__
        __XX________XX__
        ____XXXXXXXX____
        ________________
    },
    { // [4B] K
        ________________
        __XX____XXXX____
        __XX__XX________
        __XXXX__________
        __XX__XX________
        __XX____XX______
        __XX______XX____
        ________________
    },
    { // [4C] L
        ________________
        __XX____________
        __XX____________
        __XX____________
        __XX____________
        __XX____________
        __XXXXXXXXXXXX__
        ________________
    },
    { // [4D] M
        ________________
        __XX________XX__
        __XXXX____XXXX__
        __XX__XXXX__XX__
        __XX________XX__
        __XX________XX__
        __XX________XX__
        ________________
    },
    { // [4E] N
        ________________
        __XX________XX__
        __XXXX______XX__
        __XX__XX____XX__
        __XX____XX__XX__
        __XX______XXXX__
        __XX________XX__
        ________________
    },
    { // [4F] O
        ________________
        ____XXXXXXXX____
        __XX________XX__
        __XX________XX__
        __XX________XX__
        __XX________XX__
        ____XXXXXXXX____
        ________________
    },
    { // [50] P
        ________________
        __XXXXXXXXXX____
        __XX________XX__
        __XXXXXXXXXX____
        __XX____________
        __XX____________
        __XX____________
        ________________
    },
    { // [51] Q
        ________________
        ____XXXXXXXX____
        __XX________XX__
        __XX________XX__
        __XX____XX__XX__
        __XX______XX____
        ____XXXXXX__XX__
        ________________
    },
    { // [52] R
        ________________
        __XXXXXXXXXX____
        __XX________XX__
        __XXXXXXXXXX____
        __XX____XX______
        __XX______XX____
        __XX________XX__
        ________________
    },
    { // [53] S
        ________________
        ____XXXXXXXXXX__
        __XX____________
        ____XXXXXXXX____
        ____________XX__
        __XX________XX__
        ____XXXXXXXX____
        ________________
    },
    { // [54] T
        ________________
        __XXXXXXXXXXXX__
        ______XX________
        ______XX________
        ______XX________
        ______XX________
        ______XX________
        ________________
    },
    { // [55] U
        ________________
        __XX________XX__
        __XX________XX__
        __XX________XX__
        __XX________XX__
        __XX________XX__
        ____XXXXXXXX____
        ________________
    },
    { // [56] V
        ________________
        __XX________XX__
        __XX________XX__
        ____XX____XX____
        ____XX____XX____
        ______XXXX______
        ______XXXX______
        ________________
    },
    { // [57] W
        ________________
        __XX______XX____
        __XX______XX____
        __XX__XX__XX____
        ____XXXXXX______
        ____XX__XX______
        ____XX__XX______
        ________________
    },
    { // [58] X
        ________________
        __XX________XX__
        ____XX____XX____
        ______XXXX______
        ______XXXX______
        ____XX____XX____
        __XX________XX__
        ________________
    },
    { // [59] Y
        ________________
        __XX________XX__
        ____XX____XX____
        ______XXXX______
        ______XX________
        ______XX________
        ______XX________
        ________________
    },
    { // [5A] Z
        ________________
        __XXXXXXXXXXXX__
        __________XX____
        ________XX______
        ______XX________
        ____XX__________
        __XXXXXXXXXXXX__
        ________________
    },
    { // [5B] [
        ____XXXXXXXX____
        ____XX__________
        ____XX__________
        ____XX__________
        ____XX__________
        ____XX__________
        ____XX__________
        ____XXXXXXXX____
    },
    { // [5C] \        .
        ________________
        __XX____________
        ____XX__________
        ______XX________
        ________XX______
        __________XX____
        ____________XX__
        ________________
    },
    { // [5D] ]
        ____XXXXXXXX____
        __________XX____
        __________XX____
        __________XX____
        __________XX____
        __________XX____
        __________XX____
        ____XXXXXXXX____
    },
    { // [5E] ^
        ________________
        ______XX________
        ____XX__XX______
        __XX______XX____
        ________________
        ________________
        ________________
        ________________
    },
    { // [5F] 
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        XXXXXXXXXXXXXXXX
    },
    { // [60] `
        ________________
        ______XX________
        ________XX______
        ________________
        ________________
        ________________
        ________________
        ________________
    },
    { // [61] a
        ________________
        ________________
        ____XXXXXXXX____
        ____________XX__
        ____XXXXXXXXXX__
        __XX________XX__
        ____XXXXXXXXXX__
        ________________
    },
    { // [62] b
        ________________
        __XX____________
        __XX____________
        __XXXXXXXXXX____
        __XX________XX__
        __XX________XX__
        __XXXXXXXXXX____
        ________________
    },
    { // [63] c
        ________________
        ________________
        ________________
        ____XXXXXXXXXX__
        __XX____________
        __XX____________
        ____XXXXXXXXXX__
        ________________
    },
    { // [64] d
        ________________
        ____________XX__
        ____________XX__
        ____XXXXXXXXXX__
        __XX________XX__
        __XX________XX__
        ____XXXXXXXXXX__
        ________________
    },
    { // [65] e
        ________________
        ________________
        ____XXXXXXXX____
        __XX________XX__
        __XXXXXXXXXX____
        __XX____________
        ____XXXXXXXXXX__
        ________________
    },
    { // [66] f
        ________________
        ________XXXX____
        ______XX________
        __XXXXXXXXXXXX__
        ______XX________
        ______XX________
        ______XX________
        ________________
    },
    { // [67] g
        ________________
        ________________
        ________________
        ____XXXXXXXX____
        __XX________XX__
        ____XXXXXXXXXX__
        ____________XX__
        __XXXXXXXXXX____
    },
    { // [68] h
        ________________
        __XX____________
        __XX____________
        __XXXXXXXXXX____
        __XX________XX__
        __XX________XX__
        __XX________XX__
        ________________
    },
    { // [69] i
        ________________
        ______XX________
        ________________
        ______XX________
        ______XX________
        ______XX________
        ______XX________
        ________________
    },
    { // [6A] j
        ________________
        ______XX________
        ________________
        ______XX________
        ______XX________
        ______XX________
        ______XX________
        ____XX__________
    },
    { // [6B] k
        ________________
        __XX____________
        __XX____________
        __XX____XXXXXX__
        __XXXXXX________
        __XX__XXXX______
        __XX______XXXX__
        ________________
    },
    { // [6C] l
        ________________
        ____XXXX________
        ______XX________
        ______XX________
        ______XX________
        ______XX________
        ________XX______
        ________________
    },
    { // [6D] m
        ________________
        ________________
        ________________
        __XXXXXXXXXX____
        __XX____XX__XX__
        __XX____XX__XX__
        __XX____XX__XX__
        ________________
    },
    { // [6E] n
        ________________
        ________________
        ________________
        __XXXXXXXXXX____
        __XX________XX__
        __XX________XX__
        __XX________XX__
        ________________
    },
    { // [6F] o
        ________________
        ________________
        ________________
        ____XXXXXXXX____
        __XX________XX__
        __XX________XX__
        ____XXXXXXXX____
        ________________
    },
    { // [70] p
        ________________
        ________________
        ________________
        __XXXXXXXXXX____
        __XX________XX__
        __XX________XX__
        __XXXXXXXXXX____
        __XX____________
    },
    { // [71] q
        ________________
        ________________
        ________________
        ____XXXXXXXXXX__
        __XX________XX__
        __XX________XX__
        ____XXXXXXXXXX__
        ____________XX__
    },
    { // [72] r
        ________________
        ________________
        ________________
        __XX__XXXXXXXX__
        __XXXX__________
        __XX____________
        __XX____________
        ________________
    },
    { // [73] s
        ________________
        ________________
        ____XXXXXXXXXX__
        __XX____________
        ____XXXXXXXX____
        ____________XX__
        __XXXXXXXXXX____
        ________________
    },
    { // [74] t
        ________________
        ______XX________
        ______XX________
        __XXXXXXXXXXXX__
        ______XX________
        ______XX________
        ________XXXX____
        ________________
    },
    { // [75] u
        ________________
        ________________
        ________________
        __XX________XX__
        __XX________XX__
        __XX________XX__
        ____XXXXXXXXXX__
        ________________
    },
    { // [76] v
        ________________
        ________________
        ________________
        __XX________XX__
        ____XX____XX____
        ____XX____XX____
        ______XXXX______
        ________________
    },
    { // [77] w
        ________________
        ________________
        ________________
        __XX______XX____
        __XX______XX____
        __XX__XX__XX____
        ____XX__XX______
        ________________
    },
    { // [78] x
        ________________
        ________________
        ________________
        __XXXX____XXXX__
        ______XXXX______
        ______XXXX______
        __XXXX____XXXX__
        ________________
    },
    { // [79] y
        ________________
        ________________
        ________________
        __XX________XX__
        ____XX____XX____
        ______XXXX______
        ______XX________
        ____XX__________
    },
    { // [7A] z
        ________________
        ________________
        ________________
        __XXXXXXXXXXXX__
        ________XXXX____
        ____XXXX________
        __XXXXXXXXXXXX__
        ________________
    },
    { // [28] (
        __________XX____
        ______XXXX______
        ______XX________
        ____XX__________
        ____XX__________
        ______XX________
        ______XXXX______
        __________XX____
    },
    { // [7C] |
        ______XX________
        ______XX________
        ______XX________
        ______XX________
        ______XX________
        ______XX________
        ______XX________
        ______XX________
    },
    { // [29] )
        ____XX__________
        ______XXXX______
        ________XX______
        __________XX____
        __________XX____
        ________XX______
        ______XXXX______
        ____XX__________
    },
    { // [7E] ~
        ________________
        ________________
        ________________
        ____XXXX____XX__
        __XX____XXXX____
        ________________
        ________________
        ________________
    },
    { // [7F] DEL
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
        ________________
    },
};


// clang-format on 



int cursor_x = 0;
int cursor_y = 0;

void clear(void) {
    memset((void*)config.address, 0, config.height * config.pitch * sizeof(uint32_t));
}

void set_pixel(int x, int y, uint32_t value) {
    *(config.address + y * config.pitch + x) = value;
}

void put_char(int cx,   int cy, uint16_t ch) {
    ch = MIN(ch, 0x7f);
    uint8_t* bitmap = glyphs[ch];

    int x_base = cx * config.font.char_width;
    int y_base = cy * config.font.char_height;

    int char_byte_width = config.font.char_width / 8;

    for (int y_offset = 0; y_offset < config.font.char_height; ++y_offset)
    {
        for (int x_offset = 0; x_offset < config.font.char_width; ++x_offset)
        {
            uint8_t bit = (bitmap[y_offset * char_byte_width + x_offset / 8] >> (7 - x_offset % 8)) & 1;
            uint32_t value = bit ? 0xFFFFFFFF : 0x00000000;

            for (int oy = 0; oy < config.scale; ++oy) {
                for (int ox = 0; ox < config.scale; ++ox) {
                    set_pixel((x_base + x_offset) * config.scale + ox, (y_base + y_offset) * config.scale + oy, value);
                }
            }
        }
    }
}

void put_str(const uint16_t* str) {
    for (; *str != 0; ++str) {
        uint16_t ch = *str;

        switch (ch) {
            case '\r':
                cursor_x = 0;
                break;
            case '\n':
                cursor_y += 1;
                break;
            default:
                put_char(cursor_x, cursor_y, ch);
                cursor_x++;
                break;
        }

        if (cursor_x >= config.width / (config.font.char_width * config.scale))
        {
            cursor_x = 0;
            cursor_y += 1;
        }
        if (cursor_y >= config.height / (config.font.char_height * config.scale))
        {
            memmove(config.address, config.address + config.font.char_height * config.scale * config.pitch, (config.height - config.font.char_height * config.scale) * config.pitch);
        }
    }
}




void console_print_str(void* data, const uint16_t* str) {
    put_str(str);
}

void init_console(EFI_GRAPHICS_OUTPUT_PROTOCOL *gop)
{
    config.address = (uint32_t*)gop->Mode->FrameBufferBase;
    config.width = gop->Mode->Info->HorizontalResolution;
    config.height = gop->Mode->Info->VerticalResolution;
    config.pitch = gop->Mode->Info->PixelsPerScanLine;
    config.scale = 2;
    config.font.char_height = 8;
    config.font.char_width = 8;
    config.font.glyph_count = 128;
    config.font.glyphs = (uint8_t**)glyphs;
    default_printer.printer = console_print_str;
}
